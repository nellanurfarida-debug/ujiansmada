<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT SMA Plus Darussalam</title>

    <style>
        :root {
            --primary-color: #10b981;
            --primary-dark: #059669;
            --bg-color: #f3f4f6;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            min-height: 100vh;
        }

        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }

        .login-card {
            width: 95%;
            max-width: 420px;
            background: white;
            padding: 35px;
            border-radius: 16px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        input, select {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }

        button {
            padding: 12px;
            border-radius: 8px;
            border: none;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }

        .btn-danger { background: var(--danger); color: white; }

        /* Exam */
        .exam-header {
            background: var(--primary-color);
            padding: 10px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* LIVE Indicator */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: .4; }
            100% { opacity: 1; }
        }

        .live-dot {
            width: 9px;
            height: 9px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 1s infinite;
            margin-right: 6px;
        }
    </style>
</head>

<body>

    <!-- STUDENT LOGIN -->
    <div id="student-login-view" class="full-screen flex-center">
        <div class="login-card">
            <div class="school-logo">üè´</div>
            <h2 style="margin-bottom:8px;color:var(--primary-color)">CBT SMA Plus Darussalam</h2>
            <p style="margin-bottom:18px;font-size:0.9rem">Asesmen Sumatif Akhir Semester Ganjil</p>

            <form id="student-form">
                <div style="text-align:left">
                    <label>Nama Lengkap</label>
                    <input id="student-name" type="text" placeholder="Masukkan nama lengkap" required />
                </div>
                <div style="text-align:left">
                    <label>Kelas</label>
                    <select id="student-class" required>
                        <option value="" disabled selected>Pilih Kelas</option>
                        <option value="X">Kelas X</option>
                        <option value="XI">Kelas XI</option>
                        <option value="XII IIS">Kelas XII IIS</option>
                        <option value="XII IBB">Kelas XII IBB</option>
                    </select>
                </div>

                <button type="submit" class="btn-primary">MULAI UJIAN</button>
            </form>

            <div id="login-msg" style="margin-top:10px;color:var(--danger)"></div>

            <div style="margin-top:18px;padding-top:12px;border-top:2px dashed #f3f4f6">
                <p style="font-size:0.8rem;color:#9ca3af;margin-bottom:10px">Area Terbatas</p>
                <button onclick="app.showAdminLogin()" style="background:#4b5563;color:#fff;width:100%">üîê Login Panitia</button>
            </div>
        </div>
    </div>

    <!-- ADMIN LOGIN -->
    <div id="admin-login-view" class="full-screen flex-center hidden" style="background:#e5e7eb">
        <div class="login-card">
            <h3>Login Panitia</h3>
            <br />
            <form id="admin-form">
                <input id="admin-user" type="text" placeholder="Username" required />
                <input id="admin-pass" type="password" placeholder="Password" required />
                <button type="submit" class="btn-primary" style="background:#374151">Masuk</button>
            </form>
            <br />
            <button onclick="app.showStudentLogin()" style="background:none;color:#666;text-decoration:underline">Kembali</button>
        </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="admin-dashboard-view" class="full-screen hidden" style="background:#e5e7eb">
        <div class="admin-dashboard">
            <div class="dashboard-header">
                <h2>‚öôÔ∏è Panel Kontrol Ujian</h2>
                <button onclick="app.adminLogout()" class="btn-danger" style="width:auto">Keluar</button>
            </div>

            <div class="dashboard-content">
                <div style="display:grid;grid-template-columns:60% 40%;gap:18px">
                    <div>
                        <div style="background:#f0fdf4;padding:14px;border-radius:8px;border:1px solid #bbf7d0;margin-bottom:16px">
                            <h4 style="color:#166534">üìù 1. Input Link Soal (Google Drive)</h4>
                            <p style="font-size:0.8rem;color:#166534;margin-bottom:10px">Pastikan akses link Google Drive diatur ke <b>Anyone with the link</b>.</p>

                            <div style="margin-bottom:8px"><label style="font-size:0.9rem">Link Soal Kelas X</label><input id="link-x" type="text" placeholder="Tempel link Google Drive di sini..." /></div>
                            <div style="margin-bottom:8px"><label style="font-size:0.9rem">Link Soal Kelas XI</label><input id="link-xi" type="text" placeholder="Tempel link Google Drive di sini..." /></div>
                            <div style="margin-bottom:8px"><label style="font-size:0.9rem">Link Soal Kelas XII IIS</label><input id="link-xii-iis" type="text" placeholder="Tempel link Google Drive di sini..." /></div>
                            <div style="margin-bottom:8px"><label style="font-size:0.9rem">Link Soal Kelas XII IBB</label><input id="link-xii-ibb" type="text" placeholder="Tempel link Google Drive di sini..." /></div>
                        </div>

                        <div style="background:#fff;border:1px solid #e5e7eb;padding:14px;border-radius:8px">
                            <h4>‚è±Ô∏è 2. Durasi Ujian (Menit)</h4>
                            <input id="exam-duration" type="number" value="90" min="1" />

                            <h4 style="margin-top:10px">üöÄ 3. Kontrol Portal</h4>
                            <div style="display:flex;gap:10px;margin-top:8px">
                                <button onclick="app.startExamMode()" class="btn-primary">Simpan & Buka Portal</button>
                                <button onclick="app.closePortal()" class="btn-danger">Tutup Portal</button>
                            </div>

                            <p id="portal-status" style="margin-top:12px;font-weight:bold;color:#666"><span class="live-dot" style="display:none"></span>Status: Menunggu Konfigurasi</p>
                        </div>
                    </div>

                    <div class="monitor-panel">
                        <h4>üì° Monitoring Siswa (Live)</h4>
                        <p style="font-size:0.8rem;color:#666">Status siswa yang sedang login (Simulasi).</p>
                        <ul id="student-monitor-list" style="list-style:none;margin-top:10px;font-size:0.9rem;padding-left:0">
                            <li style="padding:6px;border-bottom:1px solid #eee;color:#999">Belum ada siswa aktif.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- EXAM VIEW -->
    <div id="exam-view" class="exam-layout hidden">
        <div id="watermark-name" class="watermark">SISWA</div>

        <div class="exam-header">
            <div>
                <h3 id="header-student-name">Nama Siswa</h3>
                <span id="header-student-class" style="font-size:0.85rem;opacity:0.9">Kelas X</span>
            </div>
            <div class="timer-box" id="timer-display">00:00:00</div>
            <button onclick="app.finishExam()" class="btn-danger" style="width:auto;padding:8px 14px">Selesai</button>
        </div>

        <div class="exam-body" style="flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0">
            <iframe id="pdf-frame" class="pdf-viewer" src=""></iframe>
            <div id="no-pdf-msg" class="flex-center hidden" style="width:100%;color:#fff;flex-direction:column;text-align:center;padding:20px">
                <h3>Soal Tidak Ditemukan</h3>
                <p style="margin-top:10px">Mohon lapor ke pengawas bahwa soal untuk kelas Anda belum diupload.</p>
            </div>
        </div>
    </div>

    <!-- BLOCKED / DONE -->
    <div id="blocked-view" class="block-screen hidden">
        <div class="block-icon">‚ö†Ô∏è</div>
        <h1 id="blocked-title">UJIAN DIKUNCI</h1>
        <p id="blocked-msg" style="max-width:560px;margin:16px 0;font-size:1.05rem">Anda terdeteksi melakukan kecurangan dengan meninggalkan halaman ujian lebih dari batas yang ditentukan.</p>
        <button onclick="location.reload()" style="background:#fff;color:#000;margin-top:12px;padding:10px 18px;border-radius:8px">Kembali ke Awal</button>
    </div>

    <!-- SCRIPT -->
    <script>
    // --- GLOBAL STATE & STORAGE ---
    const STORAGE_KEY = 'cbt_state_v1';
    const defaultState = {
        examLinks: { 'X': null, 'XI': null, 'XII IIS': null, 'XII IBB': null },
        durationMinutes: 90,
        isPortalOpen: false,
        cheatingStrikes: 0,
        maxStrikes: 2,
        timerInterval: null,
        currentStudent: null,
        monitor: []
    };

    function loadState(){
        try{
            const raw = localStorage.getItem(STORAGE_KEY);
            if(!raw) return {...defaultState};
            const parsed = JSON.parse(raw);
            return Object.assign({}, defaultState, parsed);
        }catch(e){
            console.error('loadState err', e);
            return {...defaultState};
        }
    }

    function saveState(s){
        try{
            const toSave = {
                examLinks: s.examLinks,
                durationMinutes: s.durationMinutes,
                isPortalOpen: s.isPortalOpen,
                monitor: s.monitor || []
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
        }catch(e){ console.error('saveState err', e); }
    }

    const state = loadState();

    // --- APP ---
    const app = {
        init(){
            this.bindEvents();
            this.preventCheatingInputs();
            this.syncUIFromState();
            // ensure live indicator initial
            liveIndicator();
        },

        bindEvents(){
            const sf = document.getElementById('student-form');
            if(sf) sf.addEventListener('submit', e => { e.preventDefault(); this.handleStudentLogin(); });

            const af = document.getElementById('admin-form');
            if(af) af.addEventListener('submit', e => { e.preventDefault(); this.handleAdminLogin(); });

            window.addEventListener('storage', (e) => {
                if(e.key === STORAGE_KEY || e.key === 'cbt_last_update'){
                    const newState = loadState();
                    Object.assign(state, newState);
                    this.syncUIFromState();
                    liveIndicator();
                }
            });
        },

        syncUIFromState(){
            const portalStatus = document.getElementById('portal-status');
            if(portalStatus){
                portalStatus.innerHTML = (state.isPortalOpen ? '<span class="live-dot"></span>' : '') + (state.isPortalOpen ? 'Status: PORTAL TERBUKA (Siap Ujian)' : 'Status: PORTAL DITUTUP');
                portalStatus.style.color = state.isPortalOpen ? 'var(--primary-color)' : 'var(--danger)';
            }

            function setIf(id, val){ const el = document.getElementById(id); if(el) el.value = val || ''; }
            setIf('link-x', state.examLinks['X']);
            setIf('link-xi', state.examLinks['XI']);
            setIf('link-xii-iis', state.examLinks['XII IIS']);
            setIf('link-xii-ibb', state.examLinks['XII IBB']);
            const dur = document.getElementById('exam-duration'); if(dur) dur.value = state.durationMinutes;

            const loginMsg = document.getElementById('login-msg');
            if(loginMsg) loginMsg.innerText = state.isPortalOpen ? '' : 'Portal ujian belum dibuka oleh panitia.';

            this.renderMonitorList();
        },

        renderMonitorList(){
            const ul = document.getElementById('student-monitor-list');
            if(!ul) return;
            ul.innerHTML = '';
            if(!state.monitor || state.monitor.length === 0){
                ul.innerHTML = '<li style="padding:6px;border-bottom:1px solid #eee;color:#999">Belum ada siswa aktif.</li>';
                return;
            }
            state.monitor.slice().reverse().forEach(entry => {
                const li = document.createElement('li');
                li.style.padding = '6px';
                li.style.borderBottom = '1px solid #eee';
                li.innerText = `${entry.name} ‚Äî ${entry.kelas} (${entry.time})`;
                ul.appendChild(li);
            });
        },

        showView(viewId){
            document.querySelectorAll('body > div').forEach(div => div.classList.add('hidden'));
            const el = document.getElementById(viewId);
            if(el) el.classList.remove('hidden');
        },

        showAdminLogin(){ this.showView('admin-login-view'); },
        showStudentLogin(){ this.showView('student-login-view'); },

        handleAdminLogin(){
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            if(u === 'admin' && p === 'smadalawang20517826'){
                this.showView('admin-dashboard-view');
                this.syncUIFromState();
            } else alert('Username atau Password Salah!');
        },

        adminLogout(){ this.showStudentLogin(); },

        extractFileId(link){
            if(!link) return null;
            let m = link.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
            if(m) return m[1];
            m = link.match(/id=([a-zA-Z0-9_-]{10,})/);
            if(m) return m[1];
            m = link.match(/uc\?id=([a-zA-Z0-9_-]{10,})/);
            if(m) return m[1];
            return null;
        },

        toPreview(link){
            const id = this.extractFileId(link);
            if(!id) return null;
            return `https://drive.google.com/file/d/${id}/preview`;
        },

        startExamMode(){
            const linkX = document.getElementById('link-x').value;
            const linkXI = document.getElementById('link-xi').value;
            const linkXII_IIS = document.getElementById('link-xii-iis').value;
            const linkXII_IBB = document.getElementById('link-xii-ibb').value;
            const durationInput = document.getElementById('exam-duration');

            state.examLinks = {
                'X': this.toPreview(linkX),
                'XI': this.toPreview(linkXI),
                'XII IIS': this.toPreview(linkXII_IIS),
                'XII IBB': this.toPreview(linkXII_IBB)
            };
            state.durationMinutes = parseInt(durationInput.value) || 90;
            state.isPortalOpen = true;
            saveState(state);
            localStorage.setItem('cbt_last_update', Date.now());
            this.syncUIFromState();
            liveIndicator();
            alert('Portal Ujian Dibuka. Link soal telah disimpan untuk masing-masing kelas.');
            this.showStudentLogin();
        },

        closePortal(){
            state.isPortalOpen = false;
            saveState(state);
            localStorage.setItem('cbt_last_update', Date.now());
            this.syncUIFromState();
            liveIndicator();
            alert('Portal ditutup. Siswa tidak bisa login.');
            this.showStudentLogin();
        },

        handleStudentLogin(){
            // ensure we have latest state (important for mobile tabs)
            Object.assign(state, loadState());

            if(!state.isPortalOpen){
                document.getElementById('login-msg').innerText = 'Portal ujian belum dibuka oleh panitia.';
                return;
            }

            const name = document.getElementById('student-name').value.trim();
            const kelas = document.getElementById('student-class').value;

            if(!name || !kelas){
                alert('Nama dan kelas harus diisi.');
                return;
            }

            state.currentStudent = { name, kelas };
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');

            state.monitor = state.monitor || [];
            state.monitor.push({ name, kelas, time: timeStr });
            if(state.monitor.length > 200) state.monitor.shift();
            saveState(state);
            localStorage.setItem('cbt_last_update', Date.now());
            this.syncUIFromState();

            const confirmExam = confirm(`Halo ${name} (${kelas}).
Ujian akan segera dimulai.

PERATURAN:
1. Dilarang membuka tab lain.
2. Dilarang keluar dari layar penuh.
3. Sistem akan mengunci jika melanggar.

Siap?`);

            if(confirmExam) this.startExamSession();
        },

        startExamSession(){
            const elem = document.documentElement;
            if(elem.requestFullscreen) elem.requestFullscreen().catch(()=>{});

            document.getElementById('header-student-name').innerText = state.currentStudent.name;
            document.getElementById('header-student-class').innerText = state.currentStudent.kelas;
            document.getElementById('watermark-name').innerText = state.currentStudent.name + ' - ' + state.currentStudent.kelas;

            const iframe = document.getElementById('pdf-frame');
            const examUrl = state.examLinks[state.currentStudent.kelas];
            if(examUrl){
                iframe.src = examUrl;
                document.getElementById('no-pdf-msg').classList.add('hidden');
            } else {
                iframe.src = '';
                document.getElementById('no-pdf-msg').classList.remove('hidden');
            }

            this.startTimer(state.durationMinutes * 60);
            this.activateAntiCheat();
            this.showView('exam-view');
        },

        startTimer(durationSeconds){
            let timer = durationSeconds;
            const display = document.getElementById('timer-display');
            if(state.timerInterval) clearInterval(state.timerInterval);

            state.timerInterval = setInterval(() => {
                const hours = Math.floor(timer / 3600);
                const minutes = Math.floor((timer % 3600) / 60);
                const seconds = timer % 60;
                display.textContent = String(hours).padStart(2,'0') + ':' + String(minutes).padStart(2,'0') + ':' + String(seconds).padStart(2,'0');
                if(--timer < 0) this.finishExam(true);
            }, 1000);
        },

        finishExam(force=false){
            if(!force && !confirm('Apakah Anda yakin ingin mengakhiri ujian? Anda tidak bisa kembali.')) return;
            if(state.timerInterval) clearInterval(state.timerInterval);
            document.getElementById('blocked-title').innerText = 'UJIAN SELESAI';
            document.getElementById('blocked-msg').innerText = 'Terima kasih telah mengerjakan ujian. Silakan lapor ke pengawas dan kumpulkan Lembar Jawaban (LJK).';
            document.querySelector('#blocked-view .block-icon').innerText = '‚úÖ';
            this.showView('blocked-view');
            if(document.exitFullscreen) document.exitFullscreen().catch(()=>{});
        },

        lockExam(reason){
            if(state.timerInterval) clearInterval(state.timerInterval);
            this.showView('blocked-view');
            document.getElementById('blocked-title').innerText = 'PELANGGARAN TERDETEKSI';
            document.getElementById('blocked-msg').innerText = reason || 'Aktivitas mencurigakan terdeteksi.';
        },

        activateAntiCheat(){
            document.addEventListener('visibilitychange', () => {
                if(document.hidden) this.handleStrike('Membuka tab lain atau meminimize browser.');
            });
        },

        handleStrike(activity){
            const blockedView = document.getElementById('blocked-view');
            if(!blockedView.classList.contains('hidden')) return;
            state.cheatingStrikes = (state.cheatingStrikes || 0) + 1;
            if(state.cheatingStrikes > state.maxStrikes) this.lockExam(`Akses ditutup otomatis karena Anda meninggalkan halaman ujian sebanyak 3 kali.\n(${activity})`);
            else alert(`PERINGATAN ${state.cheatingStrikes}/3\n\nJangan tinggalkan halaman ujian! Sistem mendeteksi: ${activity}\nJika terjadi lagi, ujian akan dikunci.`);
        },

        preventCheatingInputs(){
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('copy', e => e.preventDefault());
            document.addEventListener('selectstart', e => e.preventDefault());
            document.onkeydown = function(e){
                if(e.keyCode === 123) return false;
                if(e.ctrlKey && e.shiftKey && e.keyCode === 'I'.charCodeAt(0)) return false;
                if(e.ctrlKey && e.shiftKey && e.keyCode === 'C'.charCodeAt(0)) return false;
                if(e.ctrlKey && e.shiftKey && e.keyCode === 'J'.charCodeAt(0)) return false;
                if(e.ctrlKey && e.keyCode === 'U'.charCodeAt(0)) return false;
            };
        }
    };

    // --- AUTO-RELOAD / LIVE INDICATOR ---
    function liveIndicator(){
        const el = document.getElementById('portal-status');
        if(!el) return;
        el.innerHTML = (state.isPortalOpen ? '<span class="live-dot"></span>' : '') + (state.isPortalOpen ? 'Status: PORTAL TERBUKA (LIVE)' : 'Status: PORTAL DITUTUP');
        el.style.color = state.isPortalOpen ? 'var(--primary-color)' : 'var(--danger)';
    }

    // Poll storage for changes (helps mobile browser tabs)
    setInterval(() => {
        const latest = loadState();
        if(latest.isPortalOpen !== state.isPortalOpen || JSON.stringify(latest.examLinks) !== JSON.stringify(state.examLinks)){
            Object.assign(state, latest);
            app.syncUIFromState();
            liveIndicator();
        }
    }, 1500);

    // Start
    window.addEventListener('DOMContentLoaded', () => { app.init(); });

    </script>
</body>
</html>

