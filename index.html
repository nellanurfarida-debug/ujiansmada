<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CBT SMA Plus Darussalam - Final (No Portal)</title>
  <style>
    :root{--primary-color:#10b981;--primary-dark:#059669;--text:#1f2937;--bg:#f3f4f6;--white:#ffffff;--danger:#ef4444}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma, Geneva, Verdana, sans-serif}
    body{background:var(--bg);color:var(--text);min-height:100vh}
    .hidden{display:none!important}.flex-center{display:flex;justify-content:center;align-items:center}
    .full-screen{width:100%;min-height:100vh}
    .login-card{background:var(--white);padding:32px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.08);max-width:420px;text-align:center}
    button{cursor:pointer;padding:10px 16px;border-radius:8px;border:none;font-weight:600}
    .btn-primary{background:var(--primary-color);color:#fff;width:100%}
    .btn-danger{background:var(--danger);color:#fff}
    input,select{width:100%;padding:10px;margin-bottom:12px;border:1px solid #d1d5db;border-radius:8px}
    .admin-footer{font-size:0.85rem;color:#6b7280;margin-top:12px}
    .admin-area{margin-top:16px;padding-top:12px;border-top:2px dashed #f3f4f6}
    .admin-btns{display:flex;gap:8px}
    .admin-dashboard{max-width:960px;margin:20px auto;padding:18px;background:#fff;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    .dashboard-grid{display:grid;grid-template-columns:60% 40%;gap:16px}
    .monitor-panel{background:#f9fafb;padding:12px;border-radius:8px;border:1px dashed #e5e7eb}
    .exam-layout{display:flex;flex-direction:column;min-height:100vh}
    .exam-header{background:var(--primary-color);color:#fff;padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
    .timer-box{background:rgba(255,255,255,0.18);padding:6px 12px;border-radius:18px;font-family:monospace;font-weight:700}
    .exam-body{flex:1;background:#525659;display:flex;flex-direction:column;min-height:0;overflow:hidden}
    iframe.pdf-viewer{flex:1;width:100%;height:100%;border:0}
    .watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-45deg);font-size:4.5rem;opacity:0.05;pointer-events:none;z-index:10}
    .monitor-list{list-style:none;padding:0;margin:0}
    .monitor-list li{padding:8px;border-bottom:1px solid #eee;font-size:0.95rem}
    .block-screen{position:fixed;inset:0;background:rgba(0,0,0,0.95);color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
    .small{font-size:0.85rem;color:#666}
    .live-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;background:var(--primary-color);animation:pulse 1s infinite}
    @keyframes pulse{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}
    /* ensure iframe can shrink on mobile */
    .iframe-wrap{flex:1;min-height:0;display:flex;flex-direction:column}
  </style>
</head>
<body>

  <!-- STUDENT LOGIN VIEW -->
  <div id="student-login-view" class="full-screen flex-center">
    <div class="login-card">
      <div style="font-size:2.4rem;color:var(--primary-color)">üè´</div>
      <h2 style="color:var(--primary-color);margin:8px 0">CBT SMA Plus Darussalam</h2>
      <p class="small" style="margin-bottom:16px">Asesmen Sumatif ‚Äî Gunakan nama lengkap. Soal tampil setelah tekan MULAI.</p>

      <form id="student-form">
        <label>Nama Lengkap</label>
        <input id="student-name" type="text" placeholder="Masukkan nama lengkap" required>

        <label>Kelas</label>
        <select id="student-class" required>
          <option value="" disabled selected>Pilih Kelas</option>
          <option value="X">Kelas X</option>
          <option value="XI">Kelas XI</option>
          <option value="XII IIS">Kelas XII IIS</option>
          <option value="XII IBB">Kelas XII IBB</option>
        </select>

        <button type="submit" class="btn-primary">MULAI UJIAN</button>
      </form>

      <div id="login-msg" class="small" style="margin-top:10px;color:var(--danger)"></div>

      <div class="admin-area">
        <div class="small" style="color:#9ca3af;margin-bottom:8px">Area Panitia</div>
        <button id="btn-admin" style="background:#374151;color:#fff;width:100%">üîê Login Panitia</button>
      </div>
    </div>
  </div>

  <!-- ADMIN LOGIN -->
  <div id="admin-login-view" class="full-screen flex-center hidden">
    <div class="login-card">
      <h3>Login Panitia</h3>
      <form id="admin-form">
        <input id="admin-user" placeholder="Username" required>
        <input id="admin-pass" type="password" placeholder="Password" required>
        <button type="submit" class="btn-primary" style="background:#374151">Masuk</button>
      </form>
      <div class="admin-footer"><button id="btn-back-student" style="background:none;border:none;color:#666;text-decoration:underline;margin-top:8px">Kembali</button></div>
    </div>
  </div>

  <!-- ADMIN DASHBOARD (No portal gating: saving links directly makes them available) -->
  <div id="admin-dashboard-view" class="full-screen hidden">
    <div class="admin-dashboard">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>‚öôÔ∏è Panel Panitia</h3>
        <div style="display:flex;gap:8px">
          <button id="btn-logout" class="btn-danger" style="width:auto">Keluar</button>
        </div>
      </div>

      <div class="dashboard-grid">
        <div>
          <div style="background:#f0fdf4;padding:12px;border-radius:8px;border:1px solid #bbf7d0">
            <h4 style="color:#166534;margin:0 0 8px 0">üìù Input Link Soal (Google Drive)</h4>
            <div style="margin-bottom:8px">
              <label>Link Soal Kelas X</label>
              <input id="link-x" placeholder="https://drive.google.com/...">
            </div>
            <div style="margin-bottom:8px">
              <label>Link Soal Kelas XI</label>
              <input id="link-xi" placeholder="https://drive.google.com/...">
            </div>
            <div style="margin-bottom:8px">
              <label>Link Soal Kelas XII IIS</label>
              <input id="link-xii-iis" placeholder="https://drive.google.com/...">
            </div>
            <div style="margin-bottom:8px">
              <label>Link Soal Kelas XII IBB</label>
              <input id="link-xii-ibb" placeholder="https://drive.google.com/...">
            </div>
          </div>

          <div style="margin-top:12px;background:#fff;padding:12px;border-radius:8px;border:1px solid #e5e7eb">
            <h4>‚è± Durasi Ujian (menit)</h4>
            <input id="exam-duration" type="number" value="90" min="1">
            <div class="admin-btns" style="margin-top:8px">
              <button id="btn-save" class="btn-primary">Simpan & Aktifkan Soal</button>
              <button id="btn-clear" class="btn-danger">Hapus Soal</button>
            </div>
            <p id="save-msg" class="small" style="margin-top:8px;color:#666">Perubahan tersimpan di browser ini (local).</p>
          </div>
        </div>

        <div class="monitor-panel">
          <h4>üì° Monitoring Siswa (Live)</h4>
          <p class="small" style="margin-bottom:8px">Siswa yang menekan MULAI akan muncul di sini.</p>
          <ul id="student-monitor-list" class="monitor-list">
            <li style="color:#999">Belum ada siswa aktif.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- EXAM VIEW -->
  <div id="exam-view" class="exam-layout hidden">
    <div id="watermark-name" class="watermark">SISWA</div>
    <div class="exam-header">
      <div>
        <div id="header-student-name" style="font-weight:700">Nama Siswa</div>
        <div id="header-student-class" class="small">Kelas X</div>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="timer-box" id="timer-display">00:00:00</div>
        <button id="btn-finish" class="btn-danger" style="padding:8px 12px">Selesai</button>
      </div>
    </div>

    <div class="exam-body">
      <div class="iframe-wrap">
        <iframe id="pdf-frame" class="pdf-viewer" src=""></iframe>
      </div>
      <div id="no-pdf-msg" class="flex-center hidden" style="color:white;padding:16px">Soal tidak ditemukan. Laporkan ke pengawas.</div>
    </div>
  </div>

  <!-- BLOCK / DONE -->
  <div id="blocked-view" class="block-screen hidden">
    <div style="font-size:3rem;margin-bottom:8px" id="block-icon">‚ö†Ô∏è</div>
    <h2 id="blocked-title">UJIAN DIKUNCI</h2>
    <p id="blocked-msg" style="max-width:560px;text-align:center;margin:12px 0">Aktivitas mencurigakan terdeteksi.</p>
    <button id="btn-reload" style="background:#fff;color:#000;padding:8px 12px">Kembali ke Awal</button>
  </div>

<script>
/* State stored in localStorage; removing portal gating: students can start any time and links saved by admin are used */
const STORAGE_KEY = 'cbt_state_final_v1';
const defaultState = {
  examLinks: {'X':null,'XI':null,'XII IIS':null,'XII IBB':null},
  durationMinutes: 90,
  monitor: []
};

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return JSON.parse(JSON.stringify(defaultState));
    const parsed = JSON.parse(raw);
    return Object.assign({}, defaultState, parsed);
  }catch(e){
    console.error(e);
    return JSON.parse(JSON.stringify(defaultState));
  }
}
function saveState(s){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      examLinks: s.examLinks,
      durationMinutes: s.durationMinutes,
      monitor: s.monitor || []
    }));
  }catch(e){console.error(e)}
}

let state = loadState();

/* Utils to extract Google Drive file id and produce preview link */
function extractFileId(link){
  if(!link) return null;
  let m = link.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
  if(m) return m[1];
  m = link.match(/id=([a-zA-Z0-9_-]{10,})/);
  if(m) return m[1];
  m = link.match(/uc\?id=([a-zA-Z0-9_-]{10,})/);
  if(m) return m[1];
  return null;
}
function toPreview(link){
  const id = extractFileId(link);
  if(!id) return null;
  return 'https://drive.google.com/file/d/' + id + '/preview';
}

/* App controller */
const app = {
  init(){
    this.bind();
    this.syncUI();
    // poll for changes saved from other tab (so admin can save and students see updated links)
    setInterval(()=>{ const latest=loadState(); if(JSON.stringify(latest)!==JSON.stringify(state)){ state=latest; this.syncUI(); } }, 1200);
  },
  bind(){
    document.getElementById('btn-admin').addEventListener('click', ()=> this.show('admin-login-view'));
    document.getElementById('btn-back-student').addEventListener('click', ()=> this.show('student-login-view'));
    document.getElementById('btn-logout').addEventListener('click', ()=> { this.show('student-login-view'); });

    document.getElementById('admin-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const u = document.getElementById('admin-user').value.trim();
      const p = document.getElementById('admin-pass').value.trim();
      if(u==='admin' && p==='smadalawang20517826'){ this.show('admin-dashboard-view'); this.syncUI(); } else alert('Username atau Password Salah!');
    });

    document.getElementById('btn-save').addEventListener('click', ()=>{
      state.examLinks['X'] = toPreview(document.getElementById('link-x').value.trim());
      state.examLinks['XI'] = toPreview(document.getElementById('link-xi').value.trim());
      state.examLinks['XII IIS'] = toPreview(document.getElementById('link-xii-iis').value.trim());
      state.examLinks['XII IBB'] = toPreview(document.getElementById('link-xii-ibb').value.trim());
      state.durationMinutes = parseInt(document.getElementById('exam-duration').value) || 90;
      saveState(state);
      document.getElementById('save-msg').innerText = 'Tersimpan. Siswa akan menggunakan link terbaru.';
      // trigger storage change for other tabs
      localStorage.setItem('cbt_last_update', Date.now());
      this.syncUI();
    });

    document.getElementById('btn-clear').addEventListener('click', ()=>{
      state.examLinks = {'X':null,'XI':null,'XII IIS':null,'XII IBB':null};
      saveState(state);
      this.syncUI();
      alert('Semua link soal dihapus.');
    });

    document.getElementById('student-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      this.handleStudentStart();
    });

    document.getElementById('btn-finish').addEventListener('click', ()=> this.finishExam());
    document.getElementById('btn-reload').addEventListener('click', ()=> location.reload());
  },

  show(id){
    document.querySelectorAll('body > div').forEach(d=>d.classList.add('hidden'));
    const el = document.getElementById(id);
    if(el) el.classList.remove('hidden');
  },

  syncUI(){
    // fill admin inputs
    const setIf = (id,v)=>{ const e=document.getElementById(id); if(e) e.value = v||''; };
    setIf('link-x', state.examLinks['X']);
    setIf('link-xi', state.examLinks['XI']);
    setIf('link-xii-iis', state.examLinks['XII IIS']);
    setIf('link-xii-ibb', state.examLinks['XII IBB']);
    const d=document.getElementById('exam-duration'); if(d) d.value = state.durationMinutes||90;

    // render monitor
    const ul = document.getElementById('student-monitor-list');
    if(!ul) return;
    ul.innerHTML = '';
    if(!state.monitor || state.monitor.length===0){
      ul.innerHTML = '<li style="color:#999">Belum ada siswa aktif.</li>';
      return;
    }
    state.monitor.slice().reverse().forEach(item=>{
      const li=document.createElement('li');
      li.innerText = item.name + ' ‚Äî ' + item.kelas + ' ('+ item.time +')';
      ul.appendChild(li);
    });
  },

  handleStudentStart(){
    // no portal gating: students can start anytime
    const name = document.getElementById('student-name').value.trim();
    const kelas = document.getElementById('student-class').value;
    const loginMsg = document.getElementById('login-msg');
    if(!name || !kelas){ loginMsg.innerText = 'Nama dan kelas wajib diisi.'; return; }
    loginMsg.innerText = '';

    state.currentStudent = {name,kelas};
    // add to monitor
    const now=new Date();
    const t = now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
    state.monitor = state.monitor || [];
    state.monitor.push({name,kelas,time:t});
    if(state.monitor.length>100) state.monitor.shift();
    saveState(state);
    localStorage.setItem('cbt_last_update', Date.now());
    this.syncUI();

    const confirmExam = confirm(`Halo ${name} (${kelas}).\nUjian akan segera dimulai.\n\nPERATURAN:\n1. Dilarang membuka tab lain.\n2. Dilarang keluar dari layar penuh.\n\nSiap?`);
    if(confirmExam) this.startExamSession();
  },

  startExamSession(){
    const s = state.currentStudent;
    if(!s) return;
    this.show('exam-view');
    document.getElementById('header-student-name').innerText = s.name;
    document.getElementById('header-student-class').innerText = s.kelas;
    document.getElementById('watermark-name').innerText = s.name + ' - ' + s.kelas;

    const iframe = document.getElementById('pdf-frame');
    const examUrl = state.examLinks[s.kelas];
    if(examUrl){
      iframe.src = examUrl;
      document.getElementById('no-pdf-msg').classList.add('hidden');
    } else {
      iframe.src = '';
      document.getElementById('no-pdf-msg').classList.remove('hidden');
    }

    this.startTimer((state.durationMinutes||90)*60);
    this.activateAntiCheat();
  },

  startTimer(seconds){
    const display = document.getElementById('timer-display');
    if(this._timer) clearInterval(this._timer);
    let t = seconds;
    this._timer = setInterval(()=>{
      const h = Math.floor(t/3600);
      const m = Math.floor((t%3600)/60);
      const s = t%60;
      display.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
      if(t-- <= 0){ clearInterval(this._timer); this.finishExam(true); }
    },1000);
  },

  finishExam(force=false){
    if(!force && !confirm('Akhiri ujian?')) return;
    if(this._timer) clearInterval(this._timer);
    document.getElementById('blocked-title').innerText = 'UJIAN SELESAI';
    document.getElementById('blocked-msg').innerText = 'Terima kasih. Silakan lapor ke pengawas.';
    document.getElementById('block-icon').innerText = '‚úÖ';
    this.show('blocked-view');
  },

  activateAntiCheat(){
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) this.handleStrike('Membuka tab lain'); });
  },

  handleStrike(activity){
    state.cheatingStrikes = (state.cheatingStrikes||0)+1;
    if(state.cheatingStrikes > 2){
      this.lockExam('Ditutup karena pelanggaran berulang: '+activity);
    } else {
      alert('Peringatan: jangan tinggalkan halaman! ('+activity+')');
    }
  },

  lockExam(reason){
    if(this._timer) clearInterval(this._timer);
    document.getElementById('blocked-title').innerText = 'PELANGGARAN TERDETEKSI';
    document.getElementById('blocked-msg').innerText = reason;
    this.show('blocked-view');
  }
};

window.addEventListener('DOMContentLoaded', ()=> app.init());
</script>

</body>
</html>
